# Contract: finfocus CLI v0.2.6+ Scoped Budgets

**Feature**: 001-scoped-budgets
**Date**: 2026-02-03
**CLI Version**: v0.2.6+

## Configuration Contract

### Input: ~/.finfocus/config.yaml

The action generates this configuration file for finfocus CLI.

```yaml
# finfocus budget configuration
# Generated by finfocus-action

budget:
  amount: 2000
  currency: USD
  period: monthly
  alerts:
    - threshold: 80
      type: actual
    - threshold: 100
      type: forecasted
  scopes:
    provider/aws:
      amount: 1000
    provider/gcp:
      amount: 500
    type/compute:
      amount: 1200
    tag/env:prod:
      amount: 800
```

### Schema

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `budget.amount` | number | Yes | Global budget amount |
| `budget.currency` | string | Yes | ISO 4217 currency code |
| `budget.period` | string | Yes | `monthly` \| `quarterly` \| `yearly` |
| `budget.alerts` | array | No | Alert thresholds |
| `budget.alerts[].threshold` | number | Yes | Percentage threshold (0-100+) |
| `budget.alerts[].type` | string | Yes | `actual` \| `forecasted` |
| `budget.scopes` | object | No | Scoped budget definitions |
| `budget.scopes.<scope>` | object | - | Scope configuration |
| `budget.scopes.<scope>.amount` | number | Yes | Budget amount for scope |

### Scope Key Format

| Pattern | Example | Description |
|---------|---------|-------------|
| `provider/{name}` | `provider/aws` | Cloud provider |
| `type/{type}` | `type/compute` | Resource type |
| `tag/{key:value}` | `tag/env:prod` | Cost allocation tag |

## Command Contract

### Command: `finfocus budget status`

Returns budget status including scoped budgets when configured.

```bash
finfocus budget status --output json
```

### Exit Codes

| Code | Name | Description |
|------|------|-------------|
| 0 | PASS | All budgets healthy |
| 1 | WARNING | At least one scope in warning state |
| 2 | CRITICAL | At least one scope critical (>=100%) |
| 3 | EXCEEDED | At least one scope exceeded (>=110%) |

### Output: JSON Response

#### Wrapped Format (v0.2.4+ standard)

```json
{
  "finfocus": {
    "global": {
      "spent": 1650.00,
      "budget": 2000.00,
      "currency": "USD",
      "percent_used": 82.5,
      "health_score": 72,
      "status": "warning",
      "forecast": 2100.00,
      "runway_days": 5,
      "alerts": [
        {
          "threshold": 80,
          "type": "actual",
          "triggered": true
        }
      ]
    },
    "scopes": [
      {
        "scope": "provider/aws",
        "type": "provider",
        "key": "aws",
        "spent": 900.00,
        "budget": 1000.00,
        "currency": "USD",
        "percent_used": 90.0,
        "status": "warning",
        "alerts": [
          {
            "threshold": 80,
            "type": "actual",
            "triggered": true
          }
        ]
      },
      {
        "scope": "provider/gcp",
        "type": "provider",
        "key": "gcp",
        "spent": 150.00,
        "budget": 500.00,
        "currency": "USD",
        "percent_used": 30.0,
        "status": "healthy",
        "alerts": []
      },
      {
        "scope": "type/compute",
        "type": "type",
        "key": "compute",
        "spent": 600.00,
        "budget": 1200.00,
        "currency": "USD",
        "percent_used": 50.0,
        "status": "healthy",
        "alerts": []
      },
      {
        "scope": "tag/env:prod",
        "type": "tag",
        "key": "env:prod",
        "spent": 800.00,
        "budget": 800.00,
        "currency": "USD",
        "percent_used": 100.0,
        "status": "critical",
        "alerts": [
          {
            "threshold": 100,
            "type": "actual",
            "triggered": true
          }
        ]
      }
    ]
  }
}
```

### Response Schema

| Field | Type | Description |
|-------|------|-------------|
| `finfocus.global` | object | Global budget status (existing) |
| `finfocus.scopes` | array | Array of scope statuses |
| `finfocus.scopes[].scope` | string | Full scope identifier |
| `finfocus.scopes[].type` | string | `provider` \| `type` \| `tag` |
| `finfocus.scopes[].key` | string | Scope key (e.g., "aws", "compute") |
| `finfocus.scopes[].spent` | number | Amount spent in scope |
| `finfocus.scopes[].budget` | number | Budget limit for scope |
| `finfocus.scopes[].currency` | string | Currency code |
| `finfocus.scopes[].percent_used` | number | Percentage (0-100+) |
| `finfocus.scopes[].status` | string | `healthy` \| `warning` \| `critical` \| `exceeded` |
| `finfocus.scopes[].alerts` | array | Triggered alerts for scope |

### Status Thresholds

| Status | Condition |
|--------|-----------|
| `healthy` | percent_used < 80 |
| `warning` | 80 <= percent_used < 100 |
| `critical` | 100 <= percent_used < 110 |
| `exceeded` | percent_used >= 110 |

## Error Responses

### Version Too Old

When finfocus < v0.2.6 and scoped budgets requested:

```text
Error: Scoped budgets require finfocus v0.2.6 or later.
Current version: v0.2.5
```

Exit code: 1

### Invalid Scope Format

```json
{
  "finfocus": {
    "error": "Invalid scope format",
    "details": "Scope 'invalid-scope' does not match pattern provider/*, type/*, or tag/*"
  }
}
```

Exit code: 1

### Partial Scope Failure

When some scopes succeed and others fail:

```json
{
  "finfocus": {
    "scopes": [
      {
        "scope": "provider/aws",
        "spent": 900.00,
        "budget": 1000.00,
        "status": "warning"
      }
    ],
    "errors": [
      {
        "scope": "tag/invalid:format",
        "error": "No resources found matching tag"
      }
    ]
  }
}
```

Exit code: 0 (partial success)

## Version Detection

### Command

```bash
finfocus version
```

### Output

```text
finfocus version 0.2.6
```

### Parsing

Extract version using regex: `/finfocus version (\d+\.\d+\.\d+)/`

## Backward Compatibility

| Version | Global Budget | Scoped Budgets | Notes |
|---------|---------------|----------------|-------|
| < 0.2.5 | ❌ | ❌ | Basic cost analysis only |
| 0.2.5 | ✅ | ❌ | Budget health suite added |
| 0.2.6+ | ✅ | ✅ | Scoped budgets added |

When scopes configured but CLI < 0.2.6:

- Action MUST fail immediately (FR-011)
- Error message: "Scoped budgets require finfocus v0.2.6+. Current version: {version}"
