{"version":3,"file":"259.index.js","mappings":";;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;ACdA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":[".././src/types.ts",".././src/guardrails.ts"],"sourcesContent":["/**\n * Exit codes returned by finfocus CLI for budget threshold checks.\n * Only applicable for finfocus v0.2.5 and above.\n */\nexport var BudgetExitCode;\n(function (BudgetExitCode) {\n    /** All thresholds passed */\n    BudgetExitCode[BudgetExitCode[\"PASS\"] = 0] = \"PASS\";\n    /** Warning threshold breached */\n    BudgetExitCode[BudgetExitCode[\"WARNING\"] = 1] = \"WARNING\";\n    /** Critical threshold breached */\n    BudgetExitCode[BudgetExitCode[\"CRITICAL\"] = 2] = \"CRITICAL\";\n    /** Budget exceeded */\n    BudgetExitCode[BudgetExitCode[\"EXCEEDED\"] = 3] = \"EXCEEDED\";\n})(BudgetExitCode || (BudgetExitCode = {}));\n","import * as core from '@actions/core';\nimport * as exec from '@actions/exec';\nimport { BudgetExitCode } from './types.js';\nimport { getFinfocusVersion, supportsExitCodes } from './install.js';\n/**\n * Human-readable messages for each budget threshold result.\n */\nexport const BudgetThresholdMessages = {\n    PASS: 'Budget thresholds passed',\n    WARNING: 'Warning: Approaching budget threshold',\n    CRITICAL: 'Critical: Budget threshold breached',\n    EXCEEDED: 'Budget exceeded',\n};\n/**\n * Check budget threshold using finfocus exit codes (v0.2.5+).\n * Runs `finfocus cost projected` and interprets the exit code.\n *\n * Exit codes:\n * - 0: All thresholds passed\n * - 1: Warning threshold breached\n * - 2: Critical threshold breached\n * - 3: Budget exceeded\n *\n * @param config - Action configuration\n * @returns BudgetThresholdResult with pass/fail status and severity\n */\nexport async function checkBudgetThresholdWithExitCodes(config) {\n    try {\n        const result = await exec.getExecOutput('finfocus', ['cost', 'projected', config.pulumiPlanJsonPath], {\n            ignoreReturnCode: true,\n            silent: !config.debug,\n        });\n        if (config.debug) {\n            core.debug(`Budget threshold check exit code: ${result.exitCode}`);\n            core.debug(`Budget threshold check stdout: ${result.stdout}`);\n        }\n        switch (result.exitCode) {\n            case BudgetExitCode.PASS:\n                return {\n                    passed: true,\n                    severity: 'none',\n                    exitCode: BudgetExitCode.PASS,\n                    message: BudgetThresholdMessages.PASS,\n                };\n            case BudgetExitCode.WARNING:\n                return {\n                    passed: false,\n                    severity: 'warning',\n                    exitCode: BudgetExitCode.WARNING,\n                    message: BudgetThresholdMessages.WARNING,\n                };\n            case BudgetExitCode.CRITICAL:\n                return {\n                    passed: false,\n                    severity: 'critical',\n                    exitCode: BudgetExitCode.CRITICAL,\n                    message: BudgetThresholdMessages.CRITICAL,\n                };\n            case BudgetExitCode.EXCEEDED:\n                return {\n                    passed: false,\n                    severity: 'exceeded',\n                    exitCode: BudgetExitCode.EXCEEDED,\n                    message: BudgetThresholdMessages.EXCEEDED,\n                };\n            default:\n                throw new Error(`Unexpected finfocus exit code: ${result.exitCode}`);\n        }\n    }\n    catch (error) {\n        if (error instanceof Error && error.message.startsWith('Unexpected finfocus exit code')) {\n            throw error;\n        }\n        throw new Error(`Failed to run budget threshold check: ${error instanceof Error ? error.message : String(error)}`);\n    }\n}\n/**\n * Check budget threshold using JSON parsing (fallback for finfocus < v0.2.5).\n * Uses the existing checkThreshold() function to compare cost difference against threshold.\n *\n * @param config - Action configuration\n * @param report - Finfocus report with cost data\n * @returns BudgetThresholdResult with pass/fail status\n */\nexport function checkBudgetThresholdWithJson(config, report) {\n    if (!config.threshold) {\n        return {\n            passed: true,\n            severity: 'none',\n            message: 'No threshold configured',\n        };\n    }\n    if (!report.diff) {\n        return {\n            passed: true,\n            severity: 'none',\n            message: 'No cost diff data available',\n        };\n    }\n    const currency = report.summary?.currency ?? report.currency ?? 'USD';\n    const failed = checkThreshold(config.threshold, report.diff.monthly_cost_change, currency);\n    if (failed) {\n        return {\n            passed: false,\n            severity: 'exceeded',\n            message: `Cost increase of ${report.diff.monthly_cost_change} ${currency} exceeds threshold ${config.threshold}`,\n        };\n    }\n    return {\n        passed: true,\n        severity: 'none',\n        message: `Cost within budget threshold (${report.diff.monthly_cost_change} ${currency} < ${config.threshold})`,\n    };\n}\n/**\n * Main budget threshold check orchestrator.\n * Detects finfocus version and uses exit codes (v0.2.5+) or JSON parsing (older versions).\n *\n * @param config - Action configuration\n * @param report - Finfocus report with cost data (used for JSON fallback)\n * @returns BudgetThresholdResult with pass/fail status and severity\n */\nexport async function checkBudgetThreshold(config, report) {\n    const version = await getFinfocusVersion();\n    // Handle version detection failure (getFinfocusVersion returns '0.0.0' on failure)\n    if (version === '0.0.0') {\n        core.warning('Could not detect finfocus version, falling back to JSON parsing');\n        return checkBudgetThresholdWithJson(config, report);\n    }\n    if (config.debug) {\n        core.debug(`Detected finfocus version: ${version}`);\n    }\n    const useExitCodes = supportsExitCodes(version);\n    if (config.debug) {\n        core.debug(`Using exit codes: ${useExitCodes}`);\n    }\n    if (useExitCodes) {\n        return checkBudgetThresholdWithExitCodes(config);\n    }\n    core.warning('finfocus version < 0.2.5, falling back to JSON parsing for threshold check');\n    return checkBudgetThresholdWithJson(config, report);\n}\nexport function checkThreshold(threshold, diff, currency) {\n    if (!threshold)\n        return false;\n    const regex = /^(\\d+(\\.\\d{1,2})?)([A-Z]{3})$/;\n    const match = threshold.match(regex);\n    if (!match) {\n        core.warning(`Malformed threshold input: \"${threshold}\". Expected format like \"100USD\". Skipping guardrail.`);\n        return false;\n    }\n    const limitValue = parseFloat(match[1]);\n    const limitCurrency = match[3];\n    if (limitCurrency !== currency) {\n        core.warning(`Currency mismatch in threshold. Threshold: ${limitCurrency}, Report: ${currency}. Skipping guardrail.`);\n        return false;\n    }\n    if (diff > limitValue) {\n        return true;\n    }\n    return false;\n}\n/**\n * Determines whether a carbon threshold is exceeded.\n *\n * Accepts absolute thresholds (e.g., \"10kg\" or \"10.5kgCO2e\") or percent thresholds (e.g., \"10%\").\n *\n * @param threshold - Threshold string to evaluate; absolute values are interpreted in kilograms and percent values compare (diff / baseTotal) * 100.\n * @param diff - Change in carbon emissions (in kilograms).\n * @param baseTotal - Base total emissions (in kilograms) used for percent comparisons.\n * @returns `true` if the provided `diff` exceeds the parsed threshold, `false` otherwise. Malformed thresholds or percent checks with `baseTotal <= 0` return `false`.\n */\nexport function checkCarbonThreshold(threshold, diff, baseTotal) {\n    if (!threshold)\n        return false;\n    // Pattern for absolute: \"10kg\", \"10.5kgCO2e\", etc.\n    // Pattern for percent: \"10%\"\n    const absRegex = /^(\\d+(\\.\\d{1,2})?)(kg|kgCO2e)?$/i;\n    const pctRegex = /^(\\d+(\\.\\d{1,2})?)%$/;\n    const absMatch = threshold.match(absRegex);\n    const pctMatch = threshold.match(pctRegex);\n    if (absMatch) {\n        const limitValue = parseFloat(absMatch[1]);\n        return diff > limitValue;\n    }\n    if (pctMatch) {\n        const limitPct = parseFloat(pctMatch[1]);\n        if (baseTotal <= 0)\n            return false; // Avoid division by zero or nonsensical checks\n        const currentPct = (diff / baseTotal) * 100;\n        return currentPct > limitPct;\n    }\n    core.warning(`Malformed carbon threshold input: \"${threshold}\". Expected format like \"10kg\" or \"10%\". Skipping guardrail.`);\n    return false;\n}\n/**\n * Evaluate the configured budget-health threshold against a budget health report.\n *\n * @param config - Action configuration containing an optional `failOnBudgetHealth` threshold\n * @param budgetHealth - Budget health report providing `healthScore` and `healthStatus`\n * @returns A `BudgetThresholdResult` containing pass/fail outcome, `severity`, and an explanatory `message`\n */\nexport function checkBudgetHealthThreshold(config, budgetHealth) {\n    // If no threshold is configured, pass\n    if (!config.failOnBudgetHealth) {\n        return {\n            passed: true,\n            severity: 'none',\n            message: 'No health threshold configured',\n        };\n    }\n    const threshold = config.failOnBudgetHealth;\n    const score = budgetHealth.healthScore;\n    // If health score is not available, we cannot evaluate the threshold\n    if (score === undefined) {\n        core.warning('Budget health score not available, cannot evaluate threshold');\n        return {\n            passed: true,\n            severity: 'none',\n            message: 'Budget health score not available',\n        };\n    }\n    // Check if score is below threshold\n    if (score < threshold) {\n        const severity = budgetHealth.healthStatus === 'exceeded' ? 'exceeded' :\n            budgetHealth.healthStatus === 'critical' ? 'critical' : 'warning';\n        return {\n            passed: false,\n            severity,\n            message: `Budget health score ${score} is below threshold ${threshold}`,\n        };\n    }\n    return {\n        passed: true,\n        severity: 'none',\n        message: `Budget health score ${score} meets threshold ${threshold}`,\n    };\n}\n/**\n * Check if any scoped budget has been breached.\n * A scope is considered breached if its percentUsed >= 100 and status is 'exceeded' or 'critical'.\n * Failed scopes are excluded from breach evaluation.\n *\n * @param report - Scoped budget report from finfocus CLI\n * @param failOnBreach - Whether to fail the action on breach\n * @returns BudgetThresholdResult with pass/fail status\n */\nexport function checkScopedBudgetBreach(report, failOnBreach) {\n    // If no report or breach check disabled, pass\n    if (!report || !failOnBreach) {\n        return {\n            passed: true,\n            severity: 'none',\n            message: failOnBreach ? 'No scoped budget data available' : 'Scoped budget breach check disabled',\n        };\n    }\n    // Find breached scopes (percentUsed >= 100)\n    const breachedScopes = report.scopes.filter((s) => s.percentUsed >= 100 || s.status === 'exceeded' || s.status === 'critical');\n    if (breachedScopes.length === 0) {\n        return {\n            passed: true,\n            severity: 'none',\n            message: `All ${report.scopes.length} scoped budgets within limits`,\n        };\n    }\n    // Determine severity from worst breach\n    const hasExceeded = breachedScopes.some((s) => s.status === 'exceeded');\n    const hasCritical = breachedScopes.some((s) => s.status === 'critical');\n    const severity = hasExceeded ? 'exceeded' : hasCritical ? 'critical' : 'warning';\n    const scopeNames = breachedScopes.map((s) => s.scope).join(', ');\n    return {\n        passed: false,\n        severity,\n        message: `Budget exceeded for scopes: ${scopeNames}`,\n    };\n}\n"],"names":[],"sourceRoot":""}