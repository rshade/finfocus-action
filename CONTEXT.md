# finfocus-action Context & Boundaries

## Core Architectural Identity

**finfocus-action** is a **GitHub Actions integration layer** that brings cloud
cost and sustainability insights into pull request workflows. It orchestrates
the [finfocus CLI](https://github.com/rshade/finfocus) to analyze Pulumi
infrastructure-as-code plans and surfaces actionable cost estimates,
recommendations, and environmental impact metrics directly in PR comments.

**Key Principle**: This action is a **thin orchestration wrapper**‚Äîit handles
GitHub integration (PR comments, guardrails, workflow outputs) while delegating
all cost analysis, pricing logic, and domain expertise to the finfocus CLI.

## Technical Boundaries ("Hard No's")

### What This Action Does NOT Do

| Boundary | Rationale |
|----------|-----------|
| ‚ùå **Does NOT call cloud provider APIs directly** | Delegates to finfocus CLI; avoids credential management complexity |
| ‚ùå **Does NOT implement cost calculation logic** | finfocus CLI owns all pricing models; action just formats output |
| ‚ùå **Does NOT manage infrastructure** | Purely analytical; reads plans but never creates/modifies/deletes resources |
| ‚ùå **Does NOT persist state between runs** | Stateless except for tool caching; no databases, no storage |
| ‚ùå **Does NOT run Pulumi commands** | Expects pre-generated plan.json from upstream workflow steps |
| ‚ùå **Does NOT enforce budgets** | Writes budget config; finfocus CLI enforces; action reports status |
| ‚ùå **Does NOT calculate carbon footprint** | Reads `carbon_footprint` from finfocus; displays equivalents |
| ‚ùå **Does NOT approve/reject PRs** | Posts comments; guardrails fail workflow if thresholds exceeded |
| ‚ùå **Does NOT query billing APIs** | finfocus plugins handle cloud billing authentication |
| ‚ùå **Does NOT provide custom pricing engines** | Extensibility via finfocus plugins, not action code |

### What This Action DOES

- **Install & Cache**: Downloads finfocus binary from GitHub releases
- **Configure**: Writes budget YAML config when budget inputs provided
- **Orchestrate**: Invokes `finfocus cost projected`, `recommendations`,
  `actual` commands
- **Format**: Generates markdown tables, TUI-style budget boxes, progress bars
- **Comment**: Upserts PR comments with cost analysis (via GitHub API)
- **Guard**: Fails workflow if cost/carbon thresholds exceeded
- **Export**: Provides action outputs for downstream workflow consumption

## Data Source of Truth

**Upstream (Inputs)**:

- **Pulumi Plan JSON**: Generated by upstream workflow (`pulumi preview --json`)
- **Pulumi State JSON**: Optional, for state-based cost estimation
- **Action Inputs**: Configuration from workflow YAML (thresholds, features,
  plugins)

**Authoritative Data Sources (via finfocus)**:

- **Cloud Pricing**: finfocus plugins (aws-public, gcp-plugin, etc.)
- **Billing Data**: Cloud provider APIs (via finfocus plugin credentials)
- **Carbon Intensity**: Sustainability metrics from finfocus resource analysis

**Outputs**:

- **PR Comments**: Markdown-formatted cost analysis in GitHub
- **Action Outputs**: Structured data for downstream jobs (cost, savings,
  carbon)
- **Workflow Failure**: Exit code 1 if guardrails triggered

## Interaction Model

### Inbound Interfaces

```text
GitHub Workflow (YAML)
  ‚îî‚îÄ> finfocus-action (this project)
       ‚îú‚îÄ Inputs: plan.json path, thresholds, features
       ‚îî‚îÄ Environment: GITHUB_TOKEN, plugin credentials
```

### Outbound Interfaces

```text
finfocus-action
  ‚îú‚îÄ> finfocus CLI (local subprocess)
  ‚îÇ    ‚îú‚îÄ Commands: cost projected, recommendations, actual
  ‚îÇ    ‚îî‚îÄ Plugins: aws-public, gcp-plugin, vantage, kubecost
  ‚îÇ
  ‚îú‚îÄ> GitHub API (via @actions/github)
  ‚îÇ    ‚îú‚îÄ Read: PR number, existing comments
  ‚îÇ    ‚îî‚îÄ Write: Create/update PR comments
  ‚îÇ
  ‚îî‚îÄ> GitHub Actions Runtime (via @actions/core)
       ‚îú‚îÄ Inputs: Read workflow configuration
       ‚îú‚îÄ Outputs: Export cost metrics for downstream
       ‚îî‚îÄ Failures: Set exit code for guardrails
```

### Two Operational Modes

**Standard Mode (default)**:

```text
Install finfocus ‚Üí Run cost analysis ‚Üí Post PR comment ‚Üí Check guardrails
```

**Analyzer Mode** (`analyzer-mode: true`):

```text
Install finfocus ‚Üí Setup Pulumi policy pack ‚Üí Skip PR comment
```

Analyzer mode integrates finfocus as a Pulumi policy analyzer, running during
`pulumi preview` instead of as a separate step.

## Verification: Does a Feature Violate Boundaries?

Use this checklist to evaluate new feature proposals:

### ‚úÖ Within Boundaries

- ‚úÖ Adds new PR comment formatting options (still just displaying data)
- ‚úÖ Integrates new finfocus CLI command (delegates logic to CLI)
- ‚úÖ Adds GitHub Actions output for downstream consumption (within GH
  integration)
- ‚úÖ Installs new finfocus plugin (plugin owns logic, action orchestrates)
- ‚úÖ Writes config file for finfocus to read (config delegation pattern)

### üö´ Violates Boundaries - Consider Alternatives

| Proposed Feature | Violation | Alternative |
|------------------|-----------|-------------|
| "Calculate custom pricing rules in TypeScript" | ‚ùå Implements cost logic in action | ‚úÖ Create finfocus plugin |
| "Query AWS Cost Explorer directly" | ‚ùå Calls cloud APIs | ‚úÖ Use finfocus plugin with credentials |
| "Store historical cost data in S3" | ‚ùå Persists state | ‚úÖ Downstream workflow job stores artifacts |
| "Run `pulumi preview` automatically" | ‚ùå Manages infrastructure | ‚úÖ Document upstream workflow step |
| "Approve PRs based on cost thresholds" | ‚ùå PR decision logic | ‚úÖ Use branch protection + required checks |
| "Implement FOCUS export format" | ‚ùå Cost data transformation | ‚úÖ Add to finfocus CLI, action passes through |

## Extension Model

Extensibility **should** happen through:

1. **finfocus Plugins** - Add new cost sources, pricing models,
   recommendations
2. **Action Inputs** - Configure existing features without code changes
3. **Formatter Functions** - Customize PR comment appearance (stay in
   formatter.ts)
4. **Workflow Composition** - Chain actions for advanced pipelines

Extensibility **should NOT** require:

- Forking finfocus-action to add cost calculation logic
- Modifying analyze.ts to add pricing intelligence
- Implementing cloud provider SDKs in the action codebase

## Market Context & Differentiation

**Similar Tools**:

- [Infracost](https://github.com/infracost/actions) - Terraform-focused,
  1100+ resources, 2-second estimates
- [Cloudcostify/pulumi-cost-estimation-cli](https://github.com/Cloudcostify/pulumi-cost-estimation-cli) -
  Pulumi CLI competitor

**finfocus-action Differentiation**:

- **Pulumi-Native**: First-class Pulumi support (vs Terraform-first tools)
- **Analyzer Mode**: Integrates as Pulumi policy pack for inline enforcement
- **Sustainability**: Carbon footprint + environmental equivalents
- **Budget Tracking**: Month-to-date awareness, threshold alerts
- **Actual Costs**: Compare projected vs real spending via state/billing APIs
- **Plugin Ecosystem**: Extensible via finfocus plugins (not hardcoded
  providers)

## Architectural Rationale

### Why Separate CLI from Action?

**Benefits**:

- **Local Development**: Developers can run finfocus CLI locally before pushing
- **Testing**: CLI logic testable independently of GitHub Actions runtime
- **Reusability**: CLI works in GitLab CI, CircleCI, local scripts
- **Release Cadence**: CLI and action can version independently
- **Focused Codebase**: Action stays small (orchestration) vs CLI (domain
  logic)

**Trade-offs**:

- Requires binary download step (mitigated by caching)
- Two release streams to coordinate (documented in ROADMAP.md)

### Why No State Persistence?

**Philosophy**: GitHub Actions workflows are ephemeral. State should live in
durable systems:

- **Historical Data**: Store in S3, BigQuery, or FinOps platforms (via
  downstream jobs)
- **Budget Tracking**: Read from finfocus config, let CLI enforce
- **Trend Analysis**: Fetch via `cost actual` from billing APIs (no local DB)

**Exception**: Tool caching (`@actions/tool-cache`) for performance, not
semantic state.

## Version Compatibility

| finfocus-action | Requires finfocus CLI | Key Compatibility Notes |
|-----------------|----------------------|-------------------------|
| v1.x | v0.1.3+ | Sustainability metrics, recommendations, actual costs |
| v2.x (future) | v0.3.0+ (planned) | Budget health, FOCUS export, time-series forecasting |

When finfocus CLI adds breaking changes, action should gracefully degrade or
version-gate features.

## Summary

**finfocus-action is the GitHub Actions voice for finfocus CLI**. It translates
workflow inputs into CLI invocations, formats outputs into PR comments, and
enforces guardrails‚Äîbut never reimplements cost analysis logic. New cost
intelligence belongs in finfocus CLI (or its plugins); new GitHub integrations
belong here.
